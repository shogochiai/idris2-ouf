# OUF (Onchain Upgrader Factory) Specification
# Managed by: lazy evm ask

[meta]
name = "OUF"
version = "0.1.0"
description = "Onchain Upgrader Factory - ERC-7546 Clone Factory with DAO governance"
depends = ["idris2-subcontract"]

# =============================================================================
# Factory Functions
# =============================================================================

[[spec]]
id = "REQ_FACTORY_CREATE"
description = "createUpgrader deploys new OU clone via CREATE2"
module = "Main.Functions.Factory"
priority = "critical"

[[spec]]
id = "REQ_FACTORY_REGISTRY"
description = "Factory maintains upgrader registry (id -> address)"
module = "Main.Functions.Factory"
priority = "high"

[[spec]]
id = "REQ_FACTORY_DICTIONARY"
description = "All clones share upgraderDictionary for function dispatch"
module = "Main.Functions.Factory"
priority = "high"

# =============================================================================
# Proposal Functions
# =============================================================================

[[spec]]
id = "REQ_PROPOSE_CREATE"
description = "proposeUpgrade creates new upgrade proposal"
module = "Main.Functions.ProposeUpgrade"
priority = "critical"

[[spec]]
id = "REQ_PROPOSE_VALIDATE"
description = "Proposal requires valid target, selector, newImpl"
module = "Main.Functions.ProposeUpgrade"
priority = "high"

[[spec]]
id = "REQ_PROPOSE_ONLY_PROPOSER"
description = "Only designated proposer can create proposals"
module = "Main.Functions.ProposeUpgrade"
priority = "critical"

# =============================================================================
# Vote Functions
# =============================================================================

[[spec]]
id = "REQ_VOTE_CAST"
description = "Auditor casts vote (approve/reject/requestChanges)"
module = "Main.Functions.Vote"
priority = "critical"

[[spec]]
id = "REQ_VOTE_ONCE"
description = "Each auditor can vote only once per proposal"
module = "Main.Functions.Vote"
priority = "critical"

[[spec]]
id = "REQ_VOTE_DEADLINE"
description = "Votes rejected after deadline"
module = "Main.Functions.Vote"
priority = "high"

[[spec]]
id = "REQ_VOTE_SIGNATURE"
description = "Vote requires valid auditor signature"
module = "Main.Functions.Vote"
priority = "critical"

# =============================================================================
# Tally Functions
# =============================================================================

[[spec]]
id = "REQ_TALLY_THRESHOLD"
description = "n-of-n approval required (threshold = auditorCount)"
module = "Main.Functions.Tally"
priority = "critical"

[[spec]]
id = "REQ_TALLY_AUTO_EXECUTE"
description = "Auto-execute when threshold met + proposer signature"
module = "Main.Functions.Tally"
priority = "high"

[[spec]]
id = "REQ_TALLY_STATUS"
description = "getVotingStatus returns (votes, threshold, isComplete)"
module = "Main.Functions.Tally"
priority = "medium"

# =============================================================================
# Auditor Assignment
# =============================================================================

[[spec]]
id = "REQ_AUDITOR_ASSIGN"
description = "Admin assigns auditors to proposal"
module = "Main.Functions.AssignAuditor"
priority = "critical"

[[spec]]
id = "REQ_AUDITOR_POOL"
description = "Auditors drawn from OUC-managed pool"
module = "Main.Functions.AssignAuditor"
priority = "high"

[[spec]]
id = "REQ_AUDITOR_COUNT"
description = "Progressive auditor requirement (nth upgrade needs n auditors)"
module = "Main.Functions.AssignAuditor"
priority = "medium"

# =============================================================================
# Storage Schema
# =============================================================================

[[spec]]
id = "REQ_SCHEMA_PROPOSAL"
description = "Proposal storage: target, newImpl, selector, votes, deadline, executed"
module = "Main.Storages.Schema"
priority = "critical"

[[spec]]
id = "REQ_SCHEMA_VOTES"
description = "Vote storage: nested mapping proposalId -> auditor -> decision"
module = "Main.Storages.Schema"
priority = "critical"

[[spec]]
id = "REQ_SCHEMA_AUDITORS"
description = "Auditor list storage with count"
module = "Main.Storages.Schema"
priority = "high"

# =============================================================================
# Fee Functions
# =============================================================================

[[spec]]
id = "REQ_FEE_DEPOSIT"
description = "depositFee credits ETH to principal's balance without bridging"
module = "Main.Functions.Fee"
priority = "high"

[[spec]]
id = "REQ_FEE_BRIDGE"
description = "depositAndBridge sends ETH to ckETH helper for ICP bridging"
module = "Main.Functions.Fee"
priority = "critical"

[[spec]]
id = "REQ_FEE_SLOTS"
description = "Fee storage slots: balance mapping, ckETH helper, min deposit"
module = "Main.Functions.Fee"
priority = "high"
